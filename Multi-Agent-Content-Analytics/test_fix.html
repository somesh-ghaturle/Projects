<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>JavaScript Fix Test</h1>
    <div id="test-results"></div>

    <script>
        // Simulate the enhanced API response that was causing the error
        const simulatedOldAPIResponse = {
            agent: 'script_summarizer',
            results: {
                summary: 'A dramatic coffee shop conversation',
                characters: ['JOHN', 'SARAH'],  // OLD: Simple array
                scenes: ['INT. COFFEE SHOP - DAY'],  // OLD: Simple array
                themes: ['tension', 'conflict']  // OLD: Simple array
            }
        };

        const simulatedNewAPIResponse = {
            agent: 'script_summarizer',
            results: {
                summary: 'A dramatic coffee shop conversation between two characters dealing with past events',
                word_count: 89,
                script_quality_score: 78,
                characters: {  // NEW: Complex object structure
                    main_characters: [
                        { name: 'JOHN', dialogue_lines: 3, character_importance: 'high' },
                        { name: 'SARAH', dialogue_lines: 2, character_importance: 'high' }
                    ],
                    total_characters: 2,
                    protagonist_candidate: 'JOHN'
                },
                scenes: {  // NEW: Complex object structure
                    scene_list: [
                        { location_name: 'Coffee Shop', location_type: 'INTERIOR', time_of_day: 'DAY' }
                    ]
                },
                themes_analysis: {  // NEW: Complex object structure
                    primary_themes: ['tension', 'relationship conflict', 'unresolved issues']
                },
                dialogue_analysis: {
                    dialogue_ratio: 0.65,
                    avg_dialogue_length: 8.2
                },
                genre_analysis: {
                    predicted_genre: 'Drama'
                }
            }
        };

        function formatAgentResults(data) {
            const agent = data.agent;
            const results = data.results;
            
            let formattedHTML = `<h3>ü§ñ ${agent.replace('_', ' ').toUpperCase()} Results</h3>`;

            if (agent === 'script_summarizer') {
                // Handle new enhanced API response structure - THIS IS THE FIX!
                const characters = results.characters?.main_characters || [];
                const scenes = results.scenes?.scene_list || [];
                const themes = results.themes_analysis?.primary_themes || [];
                
                formattedHTML += `
                    <div class="result-card">
                        <h4>üìä Script Overview</h4>
                        <p><strong>Summary:</strong> ${results.summary}</p>
                        <p><strong>Word Count:</strong> ${results.word_count}</p>
                        <p><strong>Quality Score:</strong> ${results.script_quality_score || 'N/A'}/100</p>
                    </div>
                    <div class="result-card">
                        <h4>üé≠ Main Characters (${results.characters?.total_characters || 0} total)</h4>
                        ${characters.length > 0 ? 
                            characters.slice(0, 5).map(char => 
                                `<p><strong>${char.name}:</strong> ${char.dialogue_lines} lines 
                                ${char.character_importance ? `(${char.character_importance} importance)` : ''}</p>`
                            ).join('') 
                            : '<p>No clear character names detected</p>'}
                        ${results.characters?.protagonist_candidate && results.characters.protagonist_candidate !== 'Unknown' ? 
                            `<p><strong>Protagonist:</strong> ${results.characters.protagonist_candidate}</p>` : ''}
                    </div>
                    <div class="result-card">
                        <h4>üè† Scene Analysis</h4>
                        ${scenes.length > 0 ? 
                            `<p><strong>Total Scenes:</strong> ${scenes.length}</p>
                             <p><strong>Locations:</strong> ${scenes.slice(0, 3).map(s => s.location_name || s).join(', ')}${scenes.length > 3 ? '...' : ''}</p>`
                            : '<p>No scene headers detected</p>'}
                    </div>
                    <div class="result-card">
                        <h4>üé® Content Analysis</h4>
                        ${themes.length > 0 ? 
                            `<p><strong>Primary Themes:</strong> ${themes.slice(0, 3).join(', ')}</p>` : ''}
                        ${results.genre_analysis?.predicted_genre ? 
                            `<p><strong>Predicted Genre:</strong> ${results.genre_analysis.predicted_genre}</p>` : ''}
                    </div>
                `;
            }

            return formattedHTML;
        }

        // Test both old and new API responses
        const testResults = document.getElementById('test-results');

        try {
            // Test old format (should work with graceful fallbacks)
            const oldResult = formatAgentResults(simulatedOldAPIResponse);
            testResults.innerHTML += `
                <div class="result-card success">
                    <h3>‚úÖ OLD API Format Test - PASSED</h3>
                    <p>The JavaScript handles the old simple array format gracefully.</p>
                </div>
            `;
        } catch (error) {
            testResults.innerHTML += `
                <div class="result-card error">
                    <h3>‚ùå OLD API Format Test - FAILED</h3>
                    <p>Error: ${error.message}</p>
                </div>
            `;
        }

        try {
            // Test new format (this would have failed before the fix)
            const newResult = formatAgentResults(simulatedNewAPIResponse);
            testResults.innerHTML += `
                <div class="result-card success">
                    <h3>‚úÖ NEW API Format Test - PASSED</h3>
                    <p>The JavaScript correctly handles the new enhanced object structure!</p>
                    ${newResult}
                </div>
            `;
        } catch (error) {
            testResults.innerHTML += `
                <div class="result-card error">
                    <h3>‚ùå NEW API Format Test - FAILED</h3>
                    <p>Error: ${error.message}</p>
                </div>
            `;
        }

        // Demonstrate the fix
        testResults.innerHTML += `
            <div class="result-card">
                <h3>üîß The Fix Explained</h3>
                <p><strong>Problem:</strong> The old JavaScript expected simple arrays:</p>
                <pre>results.characters.join(', ')  // ‚ùå Failed when characters became an object</pre>
                <p><strong>Solution:</strong> Extract arrays from the new object structure:</p>
                <pre>const characters = results.characters?.main_characters || [];  // ‚úÖ Works with both formats</pre>
                <p><strong>Benefits:</strong></p>
                <ul>
                    <li>‚úÖ Backwards compatible with old API responses</li>
                    <li>‚úÖ Supports new enhanced API structure</li>
                    <li>‚úÖ Defensive programming with fallbacks</li>
                    <li>‚úÖ Shows detailed character information instead of just names</li>
                    <li>‚úÖ Displays script quality scores and advanced analytics</li>
                </ul>
            </div>
        `;
    </script>
</body>
</html>
